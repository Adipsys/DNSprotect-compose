version: '3.7'

volumes:
 pdns_vol01:
 pdns-db_vol01:
 ssl-certificates_vol01:

services:
 dnsp-db:
    image: docker.adipsys.com:5000/dnsp-ha-db
    restart: always
    environment:
      - DB_SERVICE_NAME=dbcluster
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    #  - MYSQL_DATABASE=dnsprotect
    #  - MYSQL_USER=dnsprotect
    #  - MYSQL_PASSWORD=dnsprotect
    deploy:
      placement:
    #          max_replicas_per_node: 1
               constraints:
                   - node.role == manager
    volumes:
          - 'pdns-db_vol01:/var/lib/mysql/'
    #     - 'pdns_vol01:/lock/'

 dnsp-web:
    image: docker.adipsys.com:5000/dnsp-ha-web
    restart: always
    environment:
         - OPERATOR=${OPERATOR}
         - SERVER_ALIAS=${SERVER_ALIAS}
         - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
         - ADMIN_PASSWD=${ADMIN_PASSWD}
         - RSYSLOG_SERVER=${RSYSLOG_SERVER}
    deploy:
      placement:
    #          max_replicas_per_node: 1
               constraints:
                   - node.role == manager
    ports:
              - ${WEB_IHM_PORT}:80
              - ${WEB_IHM_SSL_PORT}:443
    volumes:
              - 'ssl-certificates_vol01:/root/ssl_certificates/'
              - 'pdns_vol01:/etc/powerdns/'
              - 'pdns_vol01:/lock/'
    depends_on:
         - "dnsp-db"

 dnsp-pdns:
      image: docker.adipsys.com:5000/dnsp-ha-pdns
      restart: always
      deploy:
        placement:
      #          max_replicas_per_node: 1
                 constraints:
                     - node.role == manager
      ports:
              - ${DNS_PORT}:53/udp
      volumes:
              - 'pdns_vol01:/etc/powerdns/'
              - 'pdns_vol01:/logs/'
      depends_on:
        - "dnsp-db"

 dnsp-es:
      restart: always
      environment:
         - discovery.type=single-node
      deploy:
        placement:
        #     max_replicas_per_node: 1
             constraints:
                 - node.role != manager
      image: docker.adipsys.com:5000/dnsp-ha-es

 dnsp-ls:
      image: docker.adipsys.com:5000/dnsp-ha-ls
      restart: always
      environment:
         - discovery.type=single-node
      deploy:
          placement:
    #          max_replicas_per_node: 1
                 constraints:
                     - node.role != manager
      depends_on:
              - "dnsp-es"

 dnsp-fb:
      image: docker.adipsys.com:5000/dnsp-ha-fb
      restart: always
      deploy:
          placement:
    #          max_replicas_per_node: 1
                 constraints:
                     - node.role == manager
      volumes:
              - 'pdns_vol01:/logs/'
      depends_on:
              - "dnsp-es"
              - "dnsp-ls"
